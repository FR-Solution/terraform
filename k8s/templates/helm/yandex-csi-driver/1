---
# Source: yandex-csi-controller/templates/rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: yandex-csi-node
---
# Source: yandex-csi-controller/templates/rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: yandex-csi-controller
---
# Source: yandex-csi-controller/templates/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: yandex-csi-controller
type: Opaque
stringData:
  serviceAccountJSON: |
        {"created_at":"${ yandex_csi_driver_sa_sa.created_at }","id":"${ yandex_csi_driver_sa_sa.id }","key_algorithm":"${ yandex_csi_driver_sa_sa.key_algorithm }","private_key":"${ indent(6 ,yandex_csi_driver_sa_sa.private_key) }","public_key":"${ indent(6 ,yandex_csi_driver_sa_sa.public_key) }","service_account_id":"${ yandex_csi_driver_sa_sa.service_account_id }"}
  folderID: ${ yandex_csi_driver_sa_sa.folder_id }
---
# Source: yandex-csi-controller/templates/storage-classes.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: yc-network-hdd
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: yandex.csi.flant.com
parameters:
  typeID: network-hdd
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Delete
---
# Source: yandex-csi-controller/templates/storage-classes.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: yc-network-ssd
provisioner: yandex.csi.flant.com
parameters:
  typeID: network-ssd
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Delete
---
# Source: yandex-csi-controller/templates/storage-classes.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: yc-network-ssd-nonreplicated
provisioner: yandex.csi.flant.com
parameters:
  typeID: network-ssd-nonreplicated
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Delete
---
# Source: yandex-csi-controller/templates/rbac.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-csi-driver-registrar
rules:
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
---
# Source: yandex-csi-controller/templates/rbac.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-csi-external-provisioner
rules:
  - apiGroups: [""]
    resources: ["persistentvolumes"]
    verbs: ["get", "list", "watch", "create", "delete"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "update"]
  - apiGroups: ["storage.k8s.io"]
    resources: ["storageclasses"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["list", "watch", "create", "update", "patch"]
  - apiGroups: ["storage.k8s.io"]
    resources: ["csinodes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["snapshot.storage.k8s.io"]
    resources: ["volumesnapshots"]
    verbs: ["get", "list"]
  - apiGroups: ["snapshot.storage.k8s.io"]
    resources: ["volumesnapshotcontents"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["replicasets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  - apiGroups: ["storage.k8s.io"]
    resources: ["csistoragecapacities"]
    verbs: ["get", "list", "watch"]
---
# Source: yandex-csi-controller/templates/rbac.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-csi-external-attacher
rules:
  - apiGroups: [""]
    resources: ["persistentvolumes"]
    verbs: ["get", "list", "watch", "update", "patch"]
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["storage.k8s.io"]
    resources: ["csinodes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["storage.k8s.io"]
    resources: ["volumeattachments"]
    verbs: ["get", "list", "watch", "update", "patch"]
  - apiGroups: ["storage.k8s.io"]
    resources: ["volumeattachments/status"]
    verbs: ["get", "list", "watch", "update", "patch"]
---
# Source: yandex-csi-controller/templates/rbac.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-csi-external-resizer
rules:
  - apiGroups: [""]
    resources: ["persistentvolumes"]
    verbs: ["get", "list", "watch", "update", "patch"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims/status"]
    verbs: ["update", "patch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["list", "watch", "create", "update", "patch"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
---
# Source: yandex-csi-controller/templates/rbac.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-csi-external-snapshotter
rules:
  - apiGroups: [""]
    resources: ["persistentvolumes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "update"]
  - apiGroups: ["storage.k8s.io"]
    resources: ["storageclasses"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["list", "watch", "create", "update", "patch"]
  - apiGroups: ["snapshot.storage.k8s.io"]
    resources: ["volumesnapshotclasses"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["snapshot.storage.k8s.io"]
    resources: ["volumesnapshotcontents"]
    verbs: ["create", "get", "list", "watch", "update", "delete"]
  - apiGroups: ["snapshot.storage.k8s.io"]
    resources: ["volumesnapshots"]
    verbs: ["get", "list", "watch", "update"]
  - apiGroups: ["snapshot.storage.k8s.io"]
    resources: ["volumesnapshots/status"]
    verbs: ["update"]
  - apiGroups: ["apiextensions.k8s.io"]
    resources: ["customresourcedefinitions"]
    verbs: ["create", "list", "watch", "delete"]
---
# Source: yandex-csi-controller/templates/rbac.yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-csi-driver-registrar
subjects:
  - kind: ServiceAccount
    name: yandex-csi-node
    namespace: kube-fraima-csi
roleRef:
  kind: ClusterRole
  name: release-name-csi-driver-registrar
  apiGroup: rbac.authorization.k8s.io
---
# Source: yandex-csi-controller/templates/rbac.yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-csi-external-provisioner
subjects:
  - kind: ServiceAccount
    name: yandex-csi-controller
    namespace: kube-fraima-csi
roleRef:
  kind: ClusterRole
  name: release-name-csi-external-provisioner
  apiGroup: rbac.authorization.k8s.io
---
# Source: yandex-csi-controller/templates/rbac.yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-csi-external-attacher
subjects:
  - kind: ServiceAccount
    name: yandex-csi-controller
    namespace: kube-fraima-csi
roleRef:
  kind: ClusterRole
  name: release-name-csi-external-attacher
  apiGroup: rbac.authorization.k8s.io
---
# Source: yandex-csi-controller/templates/rbac.yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-csi-external-resizer
subjects:
  - kind: ServiceAccount
    name: yandex-csi-controller
    namespace: kube-fraima-csi
roleRef:
  kind: ClusterRole
  name: release-name-csi-external-resizer
  apiGroup: rbac.authorization.k8s.io
---
# Source: yandex-csi-controller/templates/rbac.yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-csi-external-snapshotter
subjects:
  - kind: ServiceAccount
    name: yandex-csi-controller
    namespace: kube-fraima-csi
roleRef:
  kind: ClusterRole
  name: release-name-csi-external-snapshotter
  apiGroup: rbac.authorization.k8s.io
---
# Source: yandex-csi-controller/templates/csi-node.yaml
kind: DaemonSet
apiVersion: apps/v1
metadata:
  name: yandex-csi-node
spec:
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: yandex-csi-node
  template:
    metadata:
      labels:
        app: yandex-csi-node
    spec:
      
      serviceAccountName: yandex-csi-node
      hostNetwork: true
      tolerations:
        - operator: Exists

      nodeSelector:
        provider: yandex

      containers:
        - name: yandex-csi-node-driver-registrar
          image: quay.io/k8scsi/csi-node-driver-registrar:v1.3.0

          args:
            - --csi-address=$(ADDRESS)
            - --kubelet-registration-path=$(DRIVER_REG_SOCK_PATH)
            - --v=2

          env:
            - name: ADDRESS
              value: /csi/csi.sock
            - name: DRIVER_REG_SOCK_PATH
              value: /var/lib/kubelet/plugins/yandex.csi.flant.com/csi.sock

          resources:
            limits:
              cpu: 100m
              memory: 256Mi
            requests:
              cpu: 10m
              memory: 40Mi

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true

          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File

          volumeMounts:
            - mountPath: /csi
              name: plugin-dir
            - mountPath: /registration
              name: registration-dir

        - name: yandex-csi-node
          args:
            - --endpoint=$(CSI_ENDPOINT)

          env:
          - name: CSI_ENDPOINT
            value: unix:/csi/csi.sock

          - name: CSI_NODE_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: spec.nodeName

          - name: YANDEX_AUTH_KEYS
            valueFrom:
              secretKeyRef:
                name: yandex-csi-controller
                key: serviceAccountJSON

          image: dobrykot/cluster-csi-controller:v0.9.12
        
          imagePullPolicy: IfNotPresent
          livenessProbe:
            failureThreshold: 5
            httpGet:
              path: /healthz
              port: healthz
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 3

          ports:
            - containerPort: 9808
              name: healthz
              protocol: TCP

          resources:
            limits:
              cpu: 100m
              memory: 256Mi
            requests:
              cpu: 10m
              memory: 40Mi

          securityContext:
            privileged: true
            readOnlyRootFilesystem: true

          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File

          volumeMounts:
            - mountPath: /var/lib/kubelet
              mountPropagation: Bidirectional
              name: kubelet-dir
            - mountPath: /csi
              name: plugin-dir
            - mountPath: /dev
              name: device-dir


        - name: liveness-probe
          image: quay.io/k8scsi/livenessprobe:v2.0.0
          args:
            - --csi-address=/csi/csi.sock

          resources:
            limits:
              cpu: 100m
              memory: 256Mi
            requests:
              cpu: 10m
              memory: 40Mi

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File

          volumeMounts:
            - mountPath: /csi
              name: plugin-dir

      dnsPolicy: ClusterFirst

      securityContext:
        fsGroup: 0
        runAsGroup: 0
        runAsNonRoot: false
        runAsUser: 0

      volumes:
        - hostPath:
            path: /var/lib/kubelet
            type: Directory
          name: kubelet-dir

        - hostPath:
            path: /var/lib/kubelet/plugins/yandex.csi.flant.com
            type: DirectoryOrCreate
          name: plugin-dir

        - hostPath:
            path: /var/lib/kubelet/plugins_registry/
            type: Directory
          name: registration-dir

        - hostPath:
            path: /dev
            type: Directory
          name: device-dir
---
# Source: yandex-csi-controller/templates/csi-controller.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
  name: yandex-csi-controller
spec:
  progressDeadlineSeconds: 600
  replicas: 2
  revisionHistoryLimit: 2
  selector:
    matchLabels:
      app: yandex-csi-controller
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: yandex-csi-controller
    spec:

      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - yandex-csi-controller
              topologyKey: kubernetes.io/hostname
            weight: 100

      containers:
      - name: csi-provisioner
        args:
          - --csi-address=$(ADDRESS)
          - --leader-election-namespace=$(NAMESPACE)
          - --leader-election=true
          - --capacity-ownerref-level=2
          - --default-fstype=ext4
          - --enable-capacity=true
          - --feature-gates=Topology=true
          - --strict-topology=true
          - --timeout=600s
          - --v=5
          - --worker-threads=10

        env:
        - name: ADDRESS
          value: "/csi/csi.sock"

        - name: POD_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name

        - name: NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace

        image: k8s.gcr.io/sig-storage/csi-provisioner:v3.1.0
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            cpu: 200m
            memory: 512Mi
          requests:
            cpu: 100m
            ephemeral-storage: 50Mi
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true

        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File

        volumeMounts:
          - name: socket-dir
            mountPath: /csi
      - name: csi-attacher
        args:
          - --csi-address=$(ADDRESS)
          - --leader-election=true
          - --leader-election-namespace=$(NAMESPACE)
          - --timeout=600s
          - --v=5
          - --worker-threads=10

        env:
          - name: ADDRESS
            value: "/csi/csi.sock"
            
          - name: NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace

        image: k8s.gcr.io/sig-storage/csi-attacher:v3.4.0
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            cpu: 200m
            memory: 512Mi
          requests:
            cpu: 100m
            ephemeral-storage: 50Mi
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true

        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File

        volumeMounts:
          - name: socket-dir
            mountPath: /csi
      - name: csi-resizer
        args:
          - --csi-address=$(ADDRESS)
          - --leader-election=true
          - --leader-election-namespace=$(NAMESPACE)
          - --timeout=600s
          - --v=5
          - --workers=10

        env:
        - name: ADDRESS
          value: "/csi/csi.sock"

        - name: NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace

        image: k8s.gcr.io/sig-storage/csi-resizer:v1.5.0
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            cpu: 200m
            memory: 512Mi
          requests:
            cpu: 100m
            ephemeral-storage: 50Mi
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true

        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File

        volumeMounts:
          - name: socket-dir
            mountPath: /csi
      - name: csi-snapshotter
        args:
          - --csi-address=$(ADDRESS)
          - --leader-election=true
          - --leader-election-namespace=$(NAMESPACE)
          - --timeout=600s
          - --v=5
          - --worker-threads=10

        env:
          - name: ADDRESS
            value: "/csi/csi.sock"

          - name: NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace

        image: k8s.gcr.io/sig-storage/csi-snapshotter:v5.0.1
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            cpu: 200m
            memory: 512Mi
          requests:
            cpu: 100m
            ephemeral-storage: 50Mi
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true

        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File

        volumeMounts:
          - name: socket-dir
            mountPath: /csi
      - name: csi-livenessprobe
        args:
          - --csi-address=$(ADDRESS)
          - --health-port=9809

        env:
          - name: ADDRESS
            value: "/csi/csi.sock"

        image: k8s.gcr.io/sig-storage/livenessprobe:v2.5.0
        imagePullPolicy: IfNotPresent

        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz
            port: 9809
            scheme: HTTP
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1

        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz
            port: 9809
            scheme: HTTP
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        resources:
          limits:
            cpu: 200m
            memory: 512Mi
          requests:
            cpu: 100m
            ephemeral-storage: 50Mi
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true

        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File

        volumeMounts:
          - name: socket-dir
            mountPath: /csi
      - name: csi-controller
        args:
          - --address=$(POD_IP):9809
          - --endpoint=unix://$(ADDRESS)
          - --folder-id=$(YANDEX_FOLDER_ID)
        env:
          - name: ADDRESS
            value: "/csi/csi.sock"

          - name: POD_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.podIP

          - name: YANDEX_AUTH_KEYS
            valueFrom:
              secretKeyRef:
                name: yandex-csi-controller
                key: serviceAccountJSON

          - name: YANDEX_FOLDER_ID
            valueFrom:
              secretKeyRef:
                name: yandex-csi-controller
                key: folderID

        image: dobrykot/cluster-csi-controller:0.9.12
        imagePullPolicy: IfNotPresent

        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz
            port: 9809
            scheme: HTTP
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        resources:
          limits:
            cpu: 200m
            memory: 512Mi
          requests:
            cpu: 100m
            ephemeral-storage: 50Mi
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true

        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File

        volumeMounts:
          - mountPath: /csi
            name: socket-dir

      dnsPolicy: Default
      hostNetwork: true
      priorityClassName: system-cluster-critical
      restartPolicy: Always
      schedulerName: default-scheduler

      securityContext:
        runAsGroup: 65534
        runAsNonRoot: true
        runAsUser: 65534

      serviceAccount: yandex-csi-controller
      serviceAccountName: yandex-csi-controller
      terminationGracePeriodSeconds: 30

      tolerations:
        - operator: Exists

      volumes:
        - emptyDir: {}
          name: socket-dir
---
# Source: yandex-csi-controller/templates/csidriver.yaml
apiVersion: storage.k8s.io/v1
kind: CSIDriver
metadata:
  name: yandex.csi.flant.com
spec:
  attachRequired: true
  podInfoOnMount: false
